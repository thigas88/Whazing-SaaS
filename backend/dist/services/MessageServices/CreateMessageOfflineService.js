'use strict';
const H = b, I = b;
(function (c, d) {
    const F = b, G = b, e = c();
    while (!![]) {
        try {
            const f = parseInt(F(0x21e)) / (-0x2487 * -0x1 + 0x315 * 0x1 + -0x1 * 0x279b) + parseInt(F(0x1fd)) / (-0x9b8 * 0x4 + -0xc9e + -0xce0 * -0x4) * (-parseInt(F(0x1b9)) / (-0x1d * -0xd0 + 0x2597 + -0x56 * 0xb6)) + parseInt(F(0x1f2)) / (0x110 * -0x12 + -0x260c * -0x1 + -0x12e8) * (-parseInt(G(0x1be)) / (0xf8d + 0xdb * -0x2d + 0x1 * 0x16f7)) + -parseInt(F(0x226)) / (0x2287 + 0x3 * 0x78d + 0x3b * -0xf8) + parseInt(G(0x212)) / (0x16e2 + -0x2482 + 0xda7) * (parseInt(G(0x1ef)) / (0x2092 + -0x181c + 0x2 * -0x437)) + -parseInt(G(0x220)) / (-0x6c * -0x17 + 0x841 + 0x1f * -0x94) * (-parseInt(G(0x1c0)) / (-0x1ef9 + 0x2604 + -0x701 * 0x1)) + -parseInt(G(0x1e5)) / (0x2 * -0x1181 + 0x1a54 + 0x8b9) * (-parseInt(F(0x1bb)) / (0x3 * 0x1dd + -0x3a * -0x19 + -0xb35));
            if (f === d)
                break;
            else
                e['push'](e['shift']());
        } catch (g) {
            e['push'](e['shift']());
        }
    }
}(a, 0x1711d7 + -0xe43c9 + 0x4ae27));
function b(c, d) {
    const e = a();
    return b = function (f, g) {
        f = f - (0x12dd + -0x2165 + -0x103f * -0x1);
        let h = e[f];
        return h;
    }, b(c, d);
}
var __importDefault = this && this[H(0x227) + H(0x1ea)] || function (c) {
    const J = H;
    return c && c[J(0x1e8)] ? c : { 'default': c };
};
const k = {};
function a() {
    const O = [
        'FLwCs',
        'join',
        'ticketId',
        'findByPk',
        'ERR_CREATI',
        'error',
        'base64',
        'userId',
        'OffLine',
        'tcmXB',
        'ls/Message',
        'ticket',
        'buffer',
        'ageOffLine',
        '/socket',
        'contactId',
        'erty',
        'psqfc',
        'PzvMT',
        '11pjvjUx',
        'rFvDZ',
        'CreateMess',
        '__esModule',
        'indexOf',
        'fault',
        'Cgrmt',
        'fromMe',
        'update',
        'eXRFF',
        '5453880VECPHl',
        'wId',
        'sNfxh',
        '4xOpfjk',
        'VPprL',
        'NG_MESSAGE',
        'VKBAH',
        'ion',
        'promisify',
        'mediaUrl',
        'writeFile',
        'all',
        'yJBWA',
        'AlmQc',
        '569716UEsOwJ',
        'Service',
        'emit',
        'contact',
        'read',
        'HTIzl',
        'default',
        'filename',
        'xmhAv',
        'JyaFW',
        'cPzSo',
        'rQFLA',
        'gluaz',
        '-notificat',
        '../../libs',
        'path',
        'toVwv',
        'defineProp',
        'rWeBu',
        'tenantId',
        'status',
        '14LwirPg',
        'Tauvh',
        'TNyjn',
        'util',
        'JwxzD',
        'getTime',
        'nrUvg',
        'split',
        '../../util',
        'fpEZr',
        'dXCYz',
        'mediaType',
        '95268RezfTQ',
        'create',
        '36fXalYv',
        'IuPMu',
        'zIsDL',
        'gROpo',
        'Wvomr',
        'fkuqT',
        '6739518YqQmPl',
        '__importDe',
        'getIO',
        'map',
        '9rzQJxt',
        'timestamp',
        '15254664QWyjlS',
        'PgKxt',
        'wpoKf',
        '2836060HbHXnn',
        'chat',
        '1747110dcwGTS',
        '../../mode',
        'body',
        'public',
        'aamNO',
        'toString',
        's/logger',
        'include',
        'UWFSr',
        'substr',
        'mimetype',
        'logger',
        'PByXK',
        'quotedMsg',
        '-appMessag',
        'ls/Ticket',
        'ManTu',
        'value'
    ];
    a = function () {
        return O;
    };
    return a();
}
k[I(0x1d1)] = !![], Object[H(0x20e) + I(0x1e2)](exports, I(0x1e8), k);
const fs_1 = require('fs'), util_1 = require(I(0x215)), path_1 = require(H(0x20c)), logger_1 = require(H(0x21a) + I(0x1c6)), MessageOffLine_1 = __importDefault(require(I(0x1c1) + I(0x1dc) + H(0x1da))), socket_1 = require(H(0x20b) + H(0x1e0)), Ticket_1 = __importDefault(require(H(0x1c1) + I(0x1cf))), Message_1 = __importDefault(require(I(0x1c1) + H(0x1dc))), writeFileAsync = (0x95 * 0x38 + -0x1aa8 + -0x5f0, util_1[H(0x1f7)])(fs_1[I(0x1f9)]), CreateMessageOffilineService = async ({
        msg: g,
        tenantId: h,
        medias: i,
        ticket: j,
        userId: l
    }) => {
        const K = H, L = I, m = {
                'HTIzl': K(0x1d6) + K(0x1f4),
                'AlmQc': L(0x1e7) + K(0x1df) + L(0x1fe),
                'yJBWA': function (q, r) {
                    return q !== r;
                },
                'JyaFW': L(0x213),
                'psqfc': L(0x1d0),
                'Wvomr': K(0x216),
                'UWFSr': function (q, r) {
                    return q === r;
                },
                'tcmXB': L(0x209),
                'FLwCs': L(0x1f5),
                'IuPMu': function (q, r, s, t) {
                    return q(r, s, t);
                },
                'zIsDL': K(0x1c3),
                'sNfxh': K(0x1d8),
                'nrUvg': K(0x205),
                'eXRFF': K(0x1cc),
                'dXCYz': L(0x200),
                'PzvMT': L(0x1dd),
                'gROpo': K(0x1cd),
                'fkuqT': function (q, r) {
                    return q !== r;
                },
                'Cgrmt': K(0x1bc),
                'VPprL': K(0x21b),
                'rFvDZ': L(0x21f),
                'rQFLA': L(0x1bf),
                'rWeBu': function (q, r) {
                    return q !== r;
                },
                'TNyjn': K(0x1c4),
                'toVwv': L(0x1bd)
            }, n = (0x86 * -0x39 + 0xf76 + 0xe60, socket_1[L(0x1b7)])(), o = {};
        o[K(0x1f0)] = undefined, o[L(0x1d4)] = j['id'], o[L(0x1c2)] = g[K(0x1c2)], o[K(0x1e1)] = j[K(0x1e1)], o[L(0x1ec)] = g[K(0x1ec)], o[L(0x201)] = !![], o[L(0x21d)] = m[K(0x208)], o[K(0x1f8)] = undefined, o[L(0x1ba)] = undefined, o[L(0x1d9)] = l;
        const p = o;
        try {
            if (i) {
                if (m[L(0x20f)](m[K(0x214)], m[L(0x20d)]))
                    await Promise[L(0x1fa)](i[L(0x1b8)](async q => {
                        const M = L, N = L, r = {};
                        r[M(0x207)] = m[N(0x202)];
                        const s = r;
                        if (m[N(0x1fb)](m[M(0x206)], m[M(0x206)]))
                            e[M(0x1cb)][M(0x1d7)](f);
                        else {
                            try {
                                if (m[M(0x1fb)](m[M(0x1e3)], m[M(0x224)])) {
                                    if (!q[M(0x204)]) {
                                        if (m[N(0x1c8)](m[N(0x1db)], m[N(0x1d2)])) {
                                            const A = x[M(0x1ca)][N(0x219)]('/')[-0x2571 + -0x19d7 + -0x3f49 * -0x1][M(0x219)](';')[-0x16db * 0x1 + -0xf5a + 0x2635 * 0x1];
                                            g[N(0x204)] = new h()[M(0x217)]() + '.' + A;
                                        } else {
                                            const A = q[M(0x1ca)][M(0x219)]('/')[0xd * -0x83 + 0x53f * 0x7 + -0x1e11][M(0x219)](';')[0x1fc4 + -0x1239 + 0xd8b * -0x1];
                                            q[M(0x204)] = new Date()[M(0x217)]() + '.' + A;
                                        }
                                    }
                                    await m[M(0x221)](writeFileAsync, (0x15f + 0xa21 + -0xb80, path_1[N(0x1d3)])(__dirname, '..', '..', '..', '..', m[M(0x222)], q[N(0x204)]), q[N(0x1de)], m[N(0x1f1)]);
                                } else
                                    throw new r(m[N(0x202)]);
                            } catch (C) {
                                m[M(0x1c8)](m[N(0x218)], m[M(0x1ee)]) ? w[M(0x1cb)][M(0x1d7)](m[N(0x1fc)], x) : logger_1[M(0x1cb)][M(0x1d7)](C);
                            }
                            const u = {
                                    ...p,
                                    'mediaUrl': q[M(0x204)],
                                    'mediaType': q[N(0x1ca)][M(0x1c9)](0x139e + -0x7 * 0x505 + 0xf85, q[N(0x1ca)][M(0x1e9)]('/'))
                                }, v = await MessageOffLine_1[N(0x203)][N(0x21f)](u), w = {};
                            w[M(0x210)] = h;
                            const x = {};
                            x[N(0x1c7)] = [
                                m[N(0x21c)],
                                {
                                    'model': Ticket_1[M(0x203)],
                                    'as': m[N(0x1e4)],
                                    'where': w,
                                    'include': [m[M(0x21c)]]
                                },
                                {
                                    'model': Message_1[N(0x203)],
                                    'as': m[M(0x223)],
                                    'include': [m[M(0x21c)]]
                                }
                            ];
                            const y = await MessageOffLine_1[M(0x203)][N(0x1d5)](v['id'], x);
                            if (!y) {
                                if (m[N(0x225)](m[M(0x1eb)], m[N(0x1f3)]))
                                    throw new Error(m[M(0x202)]);
                                else
                                    throw new r(s[N(0x207)]);
                            }
                            n['to'](h + '-' + y[N(0x1d4)][M(0x1c5)]())['to'](h + '-' + y[N(0x1dd)][N(0x211)])['to'](h + (N(0x20a) + M(0x1f6)))[N(0x1ff)](h + (M(0x1ce) + 'e'), {
                                'action': m[N(0x1e6)],
                                'message': y,
                                'ticket': y[M(0x1dd)],
                                'contact': y[N(0x1dd)][N(0x200)]
                            }), await j[M(0x1ed)]({
                                'lastMessage': y[N(0x1c2)],
                                'lastMessageAt': new Date()[M(0x217)]()
                            });
                        }
                    }));
                else {
                    const r = {};
                    return r[K(0x203)] = j, g && h[K(0x1e8)] ? i : r;
                }
            } else {
                const r = { ...p };
                r[L(0x21d)] = m[K(0x208)];
                const s = await MessageOffLine_1[L(0x203)][K(0x21f)](r), t = {};
                t[L(0x210)] = h;
                const u = {};
                u[L(0x1c7)] = [
                    m[L(0x21c)],
                    {
                        'model': Ticket_1[L(0x203)],
                        'as': m[K(0x1e4)],
                        'where': t,
                        'include': [m[L(0x21c)]]
                    },
                    {
                        'model': Message_1[L(0x203)],
                        'as': m[L(0x223)],
                        'include': [m[L(0x21c)]]
                    }
                ];
                const v = await MessageOffLine_1[L(0x203)][K(0x1d5)](s['id'], u);
                if (!v)
                    throw new Error(m[L(0x202)]);
                await j[L(0x1ed)]({
                    'lastMessage': v[L(0x1c2)],
                    'lastMessageAt': new Date()[L(0x217)]()
                }), n['to'](h + '-' + v[L(0x1d4)][L(0x1c5)]())['to'](h + '-' + v[L(0x1dd)][L(0x211)])['to'](h + (K(0x20a) + L(0x1f6)))[K(0x1ff)](h + (L(0x1ce) + 'e'), {
                    'action': m[K(0x1e6)],
                    'message': v,
                    'ticket': v[L(0x1dd)],
                    'contact': v[L(0x1dd)][L(0x200)]
                });
            }
        } catch (w) {
            logger_1[K(0x1cb)][K(0x1d7)](m[L(0x1fc)], w);
        }
    };
exports[I(0x203)] = CreateMessageOffilineService;